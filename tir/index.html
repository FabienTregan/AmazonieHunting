<head>
    <script src="../lib/wideScreen.js"></script>
    <script src="lib/gestures.js"></script>
    <script src="aiming.js"></script>
    <script src="appearing.js"></script>
    <script src="shooting.js"></script>

    <style>
        @import '../lib/wideScreen.css';

        body {
            overflow: hidden;
        }

        #main {
            position: absolute;
            overflow: hidden;
            cursor: none;
        }

        #main * {
            position: absolute;
        }

        .plan {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }

        .plan img {
            position: absolute;
            width: auto;
            height: 100%;
        }

        #animal,
        #bow,
        #arrow {
            position: absolute;
            opacity: 0;
        }

        #bow,
        #arrow {
            width: 100%;
            height: auto;
            bottom: 0px;
            left: -50%;
            margin-left: 50%;
        }
    </style>
</head>

<body>

    <div id="main" class="wideScreen">
        <div class="plan" style="z-index:60"><img id="plan5" src="plan5.jpg"></div>
        <div class="plan" style="z-index:70"><img id="plan4" src="plan4.png"></div>
        <div class="plan" style="z-index:80"><img id="plan3" src="plan3.png"></div>
        <div class="plan" style="z-index:90"><img id="plan2" src="plan2.png"></div>
        <div class="plan" style="z-index:100"><img id="plan1" src="plan1.png"></div>
        <img id="animal" style="z-index: 10;" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
        <img id="arrow" src="shooting.gif" style="z-index: 110;">
        <img id="bow" src="bow.png" style="z-index: 110;">
    </div>

    <script>
        "use strict";

        var currentState

        var animals = {
            daguet: {
                picture: "daguet.gif"
                , position: { x: 200, y: 346, z: 3 }
            }
            , sapajou: {
                picture: "sapajou.gif"
                , position: { x: 1472, y: 200, z: 2 }
            }
            , hocco: {
                picture: "hocco.gif"
                , position: { x: 1254, y: 443, z: 3 }
            }
            , tapir: {
                picture: "tapir.gif"
                , position: { x: 533, y: 319, z: 3 }
            }
            , pecari: {
                picture: "pecari.gif"
                , position: { x: 523, y: 660, z: 2 }
            }
            , agouti: {
                picture: "agouti.gif"
                , position: { x: 230, y: 692, z: 2 }
            }

        }

        var currentAnimal

        function initCurrentAnnimal(){
            var animalId = getParameter("animal")
            console.log(animalId)
            currentAnimal = animals[animalId]

        }

        initCurrentAnnimal()

        const states = {
            animalAppearing: appearing(document.getElementById("animal"), "bowAppearing")
            , bowAppearing: appearing(document.getElementById("bow"), "aiming")
            , aiming: aiming()
            , shooting: shooting()
        }

        function state(s) {
            if (s) {
                currentState = states[s]
                currentState.start()
            }
        }

        function updateScreen() {
            state(currentState.updateScreen())
            requestAnimationFrame(updateScreen)
        }

        function getParameter(paramName) {
            var url = window.location.href;
            var paramWithEgal = paramName + "="
            var paramStart = url.search(paramWithEgal) + paramWithEgal.length
            url = url.substring(paramStart)
            var paramEnd = url.search("&")

            var param = paramEnd > 0 ?
                url.substring(0, paramEnd)
                : url

            return decodeURIComponent(param)
        }

        function callbacks() {
            return {
                mouseMoved: function (e) {
                    var nextState = currentState.mouseMoved(e)
                    state(nextState)
                }
                , mouseClicked: function (e) {
                    var nextState = currentState.clicked(e)
                    state(nextState)
                }
            }
        }

        state("animalAppearing")
        window.addEventListener('load', function () {
            states.aiming.updateScreen()
            addGesturesEventListeners("main", callbacks())
            updateScreen()
        })

    </script>

</body>