<head>

    <script src="../lib/wideScreen.js"></script>
    <script src="../lib/preloader.js"></script>
    <script src="lib/gestures.js"></script>

    <style>
        @import '../lib/wideScreen.css';

        body {
            background: blue;
            overflow: hidden;
        }

        #main_canvas {
            position: absolute;
            height: 100%;
            width: 100%;
            border: none;
            padding: 0;
            background: transparent;
            cursor: none;
        }
    </style>
</head>

<body>

    <div id='main' class="wideScreen">
        <canvas id="main_canvas" height="1080" width="1920"></canvas>
    </div>

    <script>
        "use strict"

        var nbPlans = 4
        var position = -50
        var scrollSpeed = 0
        var flecheP = null
        var flecheV = null
        var flecheA = { x: 0, y: 2, z: 0 }
        var images
        var viseurP = { x: 960, y: 540 }

        function initGame(loadedImages) {
            images = loadedImages
            autoScroll()
        }

        function updateScreen() {
            updatePlansNodes(position)
            updateViseur()
        }

        function updatePlansNodes(position) {
            var mainCanvas = document.getElementById("main_canvas")
            var ctx = mainCanvas.getContext('2d')
            var flecheDrawn = false

            // remove this when done
            // ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height)

            for (var i = nbPlans; i > 0; i--) {

                var planId = "plan" + i
                var plan = images[planId]

                var distancePlan = (6 + i) * 10;

                var startX = (2500 - 1920) / 2 + position * 300 / distancePlan
                ctx.drawImage(plan, startX, 0, 1920, 1080, 0, 0, 1920, 1080)

                // dessin fleche
                if ((!flecheDrawn) && ((i == 1) || (flecheP.z > distancePlan))) {
                    var flecheWidth = images.fleche.width
                    var flecheHeight = images.fleche.height
                    var flecheApparentWidth = images.width * 50 / flecheP.z
                    var flecheApparentHeight = images.height * 50 / flecheP.z
                    ctx.globalAlpha = 0.9
                    ctx.drawImage(images.fleche, 0, 0, 64, 64, (1920 - flecheApparentWidth) / 2 + flecheP.x / flecheP.z, (1080 - flecheApparentHeight) / 2 + flecheP.y / flecheP.z, flecheApparentWidth, flecheApparentHeight)
                    ctx.globalAlpha = 1

                    flecheDrawn = true
                }
            }

        }

        function updateViseur() {
            viseurP = mouseCoordinates
            if (viseurP) {
                var mainCanvas = document.getElementById("main_canvas")
                var ctx = mainCanvas.getContext('2d')
                ctx.drawImage(images.viseur, viseurP.x - images.viseur.width / 2, viseurP.y - images.viseur.height / 2)
            }
        }

        function autoScroll(timestamp) {
            if (mouseCoordinates) {
                position += (mouseCoordinates.x - (1920 / 2)) / 1000

                position = Math.max(position, -65)
                position = Math.min(position, +65)
            }

            if ((flecheP == null) || (flecheP.z > 120)) {
                flecheP = { x: 0, y: 0, z: 50 }
                flecheV = { x: 0, y: -150, z: 0.6 }
            }

            flecheV.x += flecheA.x
            flecheV.y += flecheA.y
            flecheV.z += flecheA.z

            flecheP.x += flecheV.x
            flecheP.y += flecheV.y
            flecheP.z += flecheV.z

            updateScreen()
            requestAnimationFrame(autoScroll)
        }

        loadImages(
            {
                plan1: 'plan1.png',
                plan2: 'plan2.png',
                plan3: 'plan3.png',
                plan4: 'plan4.png',
                cible: 'cible.png',
                fleche: 'fleche.png',
                viseur: 'viseur.png',
            },
            initGame
        )

    </script>


</body>