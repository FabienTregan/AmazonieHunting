<head>

    <meta name='viewport' content='width=device-width,user-scalable=no'>
    <meta charset="utf-8" />

    <script src="../lib/wideScreen.js"></script>
    <script src="../lib/preloader.js"></script>

    <style>
        @import '../lib/wideScreen.css';
        @import '../lib/clickArea.css';

        @font-face {
            font-family: 'Source Sans';
            src: url('../font/SourceSansPro-Regular.otf') format('woff');
        }

        body {
            font-family: 'Source Sans';
            color: white;
        }

        #main_canvas {
            position: absolute;
            height: 100%;
            width: 100%;
            border: none;
            padding: 0;
            background: transparent;
        }

        #breadcrumbs {
            position: absolute;
            top: 2.0833%;
            left: 0;
            width: 33.3333%;
            height: 11.1111%;

            background-origin: padding-box;
            background-image: url('breadcrumbs.png');
            background-size: 100% 100%;
        }

        #advisor {
            position: absolute;
            bottom: 0px;
            left: 0px;
            width: 36.3021%;
            height: 26.1111%;

            box-sizing: border-box;
            padding: 2.8% 3% 2.8% 11.14%;

            background-origin: padding-box;
            background-image: url('advisor.png');
            background-size: 100% 100%;

            font-size: 0.45em;
        }
    </style>
</head>

<body oncontextmenu='event.preventDefault()'>

    <div id='main' class="wideScreen">
        <canvas id='main_canvas' height='1080' width='1920'></canvas>
        <div id='breadcrumbs'>
            <div id="back_home" class="clickArea" style="left: 12.5%; top: 16.7%; width: 16.5%; height: 65%;" onclick="window.location.href='..'"></div>
        </div>
        <div id='advisor'>
            <div comment="this div is just here to move down the next one and allow text wrapping." style='height: 45%; width: 0px; float: right;'></div>
            <div style='height: 45%; width: 25%; float: right; clear: right; '></div>
            <span id='advisor_text'></span>
            <div id="more_information" class="clickArea" style="left: 77%; top: 50%; width: 23%; height: 28%;" onclick="alert('Mettre moins d\'info en bas a gauche et en ajouter ici ?')"></div>
        </div>
    </div>

    <script>
        'use strict';

        const mapDescriptions = {
            map1: {
                tracksId : "tracks1"
                ,areasId: "areas1"
                ,entry1: { x: 100, y: 550 } 
                ,entry2: { x: 100, y: 550 } 
                ,entry3: { x: 100, y: 550 } 
            }
            , map2: {
                tracksId : "tracks2"
                ,areasId: "areas2"
                ,entry1: { x: 1550, y: 550 } 
                ,entry2: { x: 100, y: 550 } 
            }
            , map3: {
                tracksId : "tracks3"
                ,areasId: "areas3"
                ,entry1: { x: 100, y: 550 } 
                ,entry2: { x: 100, y: 550 } 
            }
            , map4: {
                tracksId : "tracks4"
                ,areasId: "areas4"
                ,entry1: { x: 100, y: 550 } 
                ,entry2: { x: 100, y: 550 } 
            }
        }

        var areasDescription = {
            0x000000: {}
            , 0xFF0000: {blocking: true}
            , 0x0000F0: {advice: {name: "Tapir du Brésil", description: "Le tapir se nourrit de nombreux fruits dont ceux des palmiers.<br>Sa chasse est réglementée."}}
            , 0x0000B0: {advice: {name: "Précari à collier", description: "A la saison sèche, il est difficile de prévoir où se trouve la pécari. Il se déplace, recherchant les graines, gousses et noix enterrées près de nombreux points d’eau résiduels."}}
            , 0x000070: {advice: {name: "Daguet rouge", description: "Cet animal discret et craintif est difficile à rencontrer. Les fleurs de certains arbres peuvent toutefois l’attirer."}}
            , 0x00F000: {goto: {mapId: "map1", entryId: "entry1" }}
        }

        const AREA_FOREST = 0xFF0000

        var initialized = false
        var mouseCoordinates

        var position
        var moveSpeed

        var mainCanvas
        var bufferCanvas
        var revealedImageData
        var maskImageData
        var areasImageData
        var currentArea
        var map
        var character
        var images

        function initGame(loadedImages) {
            images = loadedImages

            initCanvasAndImageData()

            initMap("map2", "entry1")

            addEventListenersOnMainCanvas()

            window.requestAnimationFrame(mainLoop)
        }

        function initMap(mapId, entryId) {

            position = mapDescriptions[mapId][entryId]
            moveSpeed = 0

            map = images[mapId]
            areasImageData = imageToImageData(images[mapDescriptions[mapId].areasId])

            // Drawing the map beneath the tracks instead of loading the tracks with map already painted reduces the size a lot.
            var tracksImage = images[mapDescriptions[mapId].tracksId]
            var revealedContext2d = imageToContext2d(tracksImage)
            revealedContext2d.globalCompositeOperation = 'destination-over'
            revealedContext2d.drawImage(map, 0, 0)
            revealedImageData = revealedContext2d.getImageData(0, 0, tracksImage.width, tracksImage.height)
            setTransparency(revealedImageData, 0)

            var mainCanvasContext2d = mainCanvas.getContext('2d')
            mainCanvasContext2d.drawImage(map, 0, 0)

            drawScreen()
        }

        function initCanvasAndImageData() {
            character = document.getElementById('character')

            character = images.character
            maskImageData = imageToImageData(images.mask)

            mainCanvas = document.getElementById('main_canvas')

            bufferCanvas = document.createElement('canvas')
            bufferCanvas.width = images.mask.width
            bufferCanvas.height = images.mask.height

        }

        function imageToContext2d(image) {
            var canvas = document.createElement('canvas')
            canvas.height = image.height
            canvas.width = image.width

            var context2d = canvas.getContext('2d')
            context2d.globalCompositeOperation = 'copy'
            context2d.drawImage(image, 0, 0)
            context2d.globalCompositeOperation = 'destination-over'

            return context2d
        }

        function imageToImageData(image) {
            return imageToContext2d(image).getImageData(0, 0, image.width, image.height)
        }

        function addEventListenersOnMainCanvas() {
            mainCanvas.addEventListener('dragstart', preventDefault)
            mainCanvas.addEventListener('touchstart', touchStart)
            mainCanvas.addEventListener('touchend', touchEnd)
            mainCanvas.addEventListener('touchmove', touchMove)
            mainCanvas.addEventListener('mousedown', mouseButtonDown)
            mainCanvas.addEventListener('mouseup', mouseButtonUp)
            mainCanvas.addEventListener('mouseleave', mouseButtonUp)
            mainCanvas.addEventListener('mousemove', updateMouseCoordinates)
        }

        function mainLoop(timestamp) {
            if (mouseCoordinates && moveSpeed) {
                move()
                drawScreen()
            }
            window.requestAnimationFrame(mainLoop)
        }

        function updateAdvice(advice) {
            var advisor = document.getElementById('advisor_text')

            var innerHTML
            if (advice) {
                innerHTML = 'Ce sont des traces de <b>' + advice.name + '</b><br><br>' + advice.description
            } else {
                innerHTML = "..."
            }

            advisor.innerHTML = innerHTML
        }

        function drawScreen() {
            var revealed = { x: Math.round(position.x - maskImageData.width / 2), y: Math.round(position.y - maskImageData.height / 2), height: maskImageData.height, width: maskImageData.width }

            reveal(revealedImageData, maskImageData, revealed)

            var bufferContext2d = bufferCanvas.getContext('2d')
            bufferContext2d.putImageData(revealedImageData, -revealed.x, -revealed.y, revealed.x, revealed.y, revealed.width, revealed.height)

            var mainContext2d = mainCanvas.getContext('2d')
            mainContext2d.globalCompositeOperation = 'source-over'
            mainContext2d.drawImage(map, revealed.x, revealed.y, revealed.width, revealed.height, revealed.x, revealed.y, revealed.width, revealed.height)
            mainContext2d.drawImage(bufferCanvas, revealed.x, revealed.y)

            mainContext2d.drawImage(character, position.x - character.width / 2, position.y - character.height)
        }

        function move() {
            var moveDirection = calculateMoveDirection()

            var destination = { x: position.x + moveDirection.x * moveSpeed, y: position.y + moveDirection.y * moveSpeed }
            var destinationArea = area(destination)

            if (! destinationArea.blocking) {
                position.x += moveDirection.x * moveSpeed
                position.y += moveDirection.y * moveSpeed
            
                var goto = destinationArea.goto
                if(goto) {
                    initMap(goto.mapId, goto.entryId)
                }

                updateAdvice(destinationArea.advice)
            }
        }

        function updateMouseCoordinates(e) {
            var targetClientRect = e.target.getClientRects()[0]
            mouseCoordinates = {
                x: (e.clientX - targetClientRect.left) * mainCanvas.width / targetClientRect.width
                , y: (e.clientY - targetClientRect.top) * mainCanvas.height / targetClientRect.height
            }
        }

        function calculateMoveDirection(e) {
            var x = mouseCoordinates.x - position.x
            var y = mouseCoordinates.y - position.y
            var radius = Math.sqrt(x * x + y * y)

            var result

            if (radius > 20) {
                result = { x: x / radius, y: y / radius }
            } else {
                result = { x: 0, y: 0 }
            }

            return result;
        }

        function touchStart(e) {
            e.preventDefault()
            updateMouseCoordinates(e.touches[0])
            moveSpeed = 5
        }

        function touchEnd(e) {
            e.preventDefault()
            moveSpeed = 0
        }

        function touchMove(e) {
            e.preventDefault()
            updateMouseCoordinates(e.touches[0])
        }

        function mouseButtonDown(e) {
            moveSpeed = 5
        }

        function mouseButtonUp(e) {
            moveSpeed = 0
        }

        function preventDefault(e) {
            e.preventDefault()
        }

        function setTransparency(imageData, transparency) {
            var data = imageData.data
            for (var i = 0; i < imageData.width * imageData.height; i++) {
                data[i * 4 + 3] = transparency
            }
        }

        function reveal(revealedImageData, maskImageData, revealed) {

            var maskIndex = 3
            var revealedIndex = (revealed.x + revealed.y * revealedImageData.width) * 4 + 3

            var revealedData = revealedImageData.data
            var maskData = maskImageData.data

            for (var j = 0; j < maskImageData.height; j++) {
                for (var i = 0; i < maskImageData.width; i++) {

                    var maskAlpha = maskData[maskIndex]
                    var revealedAlpha = revealedData[revealedIndex]
                    revealedData[revealedIndex] = Math.max(maskAlpha, revealedAlpha)

                    maskIndex += 4
                    revealedIndex += 4
                }
                revealedIndex += (revealedImageData.width - maskImageData.width) * 4
            }
        }

        function area(position) {
            position = { x: Math.round(position.x), y: Math.round(position.y) }
            var index = (position.x + position.y * areasImageData.width) * 4

            var red = areasImageData.data[index + 0]
            var green = areasImageData.data[index + 1]
            var blue = areasImageData.data[index + 2]

            var colorHexCode = red * 0x010000 + green * 0x000100 + blue * 0x000001
            
            var area = areasDescription[colorHexCode]

            return area
        }


        loadImages(
            {
                map1: 'map1.jpg',
                map2: 'map2.jpg',
                map3: 'map3.jpg',
                map4: 'map4.jpg',
                tracks1: 'tracks1.png',
                tracks2: 'tracks2.png',
                tracks3: 'tracks3.png',
                tracks4: 'tracks4.png',
                areas1: 'areas1.png',
                areas2: 'areas2.png',
                areas3: 'areas3.png',
                areas4: 'areas4.png',
                mask: 'mask.png',
                character: 'character.png',
            },
            initGame
        )
    </script>


</body>