<head>

    <meta name='viewport' content='width=device-width,user-scalable=no'>

    <style>
        body {
            user-select: none;

            background: blue;
            overflow: hidden;
            padding: 0px;
            margin: 0px;
        }

        #main {
            height: 40vw;
            width: 71.1vw;
            border: none;
            padding: 0;
        }

        #main_canvas {
            position: absolute;
            height: 100%;
            width: 100%;
            border: none;
            padding: 0;
            background: transparent;
            overflow: hidden;
        }

        #preload {
            display: none
        }
    </style>
</head>

<body oncontextmenu='event.preventDefault()'>

    <div id='preload'>
        <img id='map' src='map.png'>
        <img id='tracks' src='tracks.png'>
        <img id='mask' src='mask.png'>
        <img id='character' src='character.png'>
    </div>

    <div id='main'>
        <canvas id='main_canvas' height='1080' width='1920'></canvas>
    </div>

    <script>
        'use strict';

        var initialized = false
        var mouseCoordinates

        var position
        var moveSpeed

        var mainCanvas
        var bufferCanvas
        var revealedImageData
        var maskImageData
        var map
        var character

        function initGame() {
            console.log('Game initializing...')

            position = { x: 100, y: 500 }
            moveSpeed = 0

            initCanvasAndImageData()

            addEventListenersOnMainCanvas()

            drawScreen()
            window.requestAnimationFrame(mainLoop)

            console.log('Game initialize!')
        }

        function initCanvasAndImageData() {
            character = document.getElementById('character')

            map = document.getElementById('map')
            var mask = document.getElementById('mask')
            var tracks = document.getElementById('tracks')

            mask.crossOrigin = "Anonymous"
            maskImageData = imageToImageData(mask)

            // Drawing the map beneath the tracks instead of loading the tracks with map already painted reduces the size a lot.
            var revealedContext2d = imageToContext2d(tracks)
            revealedContext2d.globalCompositeOperation = 'destination-over'
            revealedContext2d.drawImage(map, 0, 0)
            revealedImageData = revealedContext2d.getImageData(0, 0, tracks.width, tracks.height)
            setTransparency(revealedImageData, 0)

            mainCanvas = document.getElementById('main_canvas')
            var mainCanvasContext2d = mainCanvas.getContext('2d')
            mainCanvasContext2d.drawImage(map, 0, 0)

            bufferCanvas = document.createElement('canvas')
            bufferCanvas.width = mask.width
            bufferCanvas.height = mask.height
        }

        function imageToContext2d(image) {
            var canvas = document.createElement('canvas')
            canvas.height = image.height
            canvas.width = image.width

            var context2d = canvas.getContext('2d')
            context2d.globalCompositeOperation = 'copy'
            context2d.drawImage(image, 0, 0)
            context2d.globalCompositeOperation = 'destination-over'

            return context2d
        }

        function imageToImageData(image) {
            return imageToContext2d(image).getImageData(0, 0, image.width, image.height)
        }

        function addEventListenersOnMainCanvas() {
            mainCanvas.addEventListener('dragstart', preventDefault)
            mainCanvas.addEventListener('touchstart', touchStart)
            mainCanvas.addEventListener('touchend', touchEnd)
            mainCanvas.addEventListener('touchmove', touchMove)
            mainCanvas.addEventListener('mousedown', mouseButtonDown)
            mainCanvas.addEventListener('mouseup', mouseButtonUp)
            mainCanvas.addEventListener('mouseleave', mouseButtonUp)
            mainCanvas.addEventListener('mousemove', updateMouseCoordinates)
        }

        function mainLoop(timestamp) {
            if (mouseCoordinates && moveSpeed) {
                move()
                drawScreen()
            }
            window.requestAnimationFrame(mainLoop)
        }

        function drawScreen() {
            var revealed = { x: Math.round(position.x - maskImageData.width / 2), y: Math.round(position.y - maskImageData.height / 2), height: maskImageData.height, width: maskImageData.width }

            reveal(revealedImageData, maskImageData, revealed)

            var bufferContext2d = bufferCanvas.getContext('2d')
            bufferContext2d.putImageData(revealedImageData, -revealed.x, -revealed.y, revealed.x, revealed.y, revealed.width, revealed.height)

            var mainContext2d = mainCanvas.getContext('2d')
            mainContext2d.globalCompositeOperation = 'source-over'
            mainContext2d.drawImage(map, revealed.x, revealed.y, revealed.width, revealed.height, revealed.x, revealed.y, revealed.width, revealed.height)
            mainContext2d.drawImage(bufferCanvas, revealed.x, revealed.y)

            mainContext2d.drawImage(character, position.x - character.width / 2, position.y - character.height)
        }


        function move() {
            var moveDirection = calculateMoveDirection()
            position.x += moveDirection.x * moveSpeed
            position.y += moveDirection.y * moveSpeed
        }

        function updateMouseCoordinates(e) {
            mouseCoordinates = {
                x: (e.clientX - e.target.offsetLeft) * mainCanvas.width / mainCanvas.offsetWidth
                , y: (e.clientY - e.target.offsetTop) * mainCanvas.height / mainCanvas.offsetHeight
            }
        }

        function calculateMoveDirection(e) {
            var x = mouseCoordinates.x - position.x
            var y = mouseCoordinates.y - position.y
            var radius = Math.sqrt(x * x + y * y)

            var result

            if (radius > 20) {
                result = { x: x / radius, y: y / radius }
            } else {
                result = { x: 0, y: 0 }
            }

            return result;
        }

        function touchStart(e) {
            e.preventDefault()
            updateMouseCoordinates(e.touches[0])
            moveSpeed = 5
        }

        function touchEnd(e) {
            e.preventDefault()
            moveSpeed = 0
        }

        function touchMove(e) {
            e.preventDefault()
            updateMouseCoordinates(e.touches[0])
        }

        function mouseButtonDown(e) {
            moveSpeed = 5
        }

        function mouseButtonUp(e) {
            moveSpeed = 0
        }

        window.addEventListener('load', initGame)

        function preventDefault(e) {
            e.preventDefault()
        }

        function setTransparency(imageData, transparency) {
            var data = imageData.data
            for (var i = 0; i < imageData.width * imageData.height; i++) {
                data[i * 4 + 3] = transparency
            }
        }

        function reveal(revealedImageData, maskImageData, revealed) {

            var maskIndex = 3
            var revealedIndex = (revealed.x + revealed.y * revealedImageData.width) * 4 + 3

            var revealedData = revealedImageData.data
            var maskData = maskImageData.data

            for (var j = 0; j < maskImageData.height; j++) {
                for (var i = 0; i < maskImageData.width; i++) {

                    var maskAlpha = maskData[maskIndex]
                    var revealedAlpha = revealedData[revealedIndex]
                    revealedData[revealedIndex] = Math.max(maskAlpha, revealedAlpha)

                    maskIndex += 4
                    revealedIndex += 4
                }
                revealedIndex += (revealedImageData.width - maskImageData.width) * 4
            }
        }

    </script>


</body>