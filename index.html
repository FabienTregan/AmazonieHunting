<head>
    <style>

        body {
            background: blue;
            overflow: hidden;
        }

        #mainCanvas {
            height: 40vw;
            width: 71.1vw;
            border: none;
            background: black;
            overflow: hidden;
        }

        #preload {
            display: none
        }

    </style>
</head>

<body>

    <div id="preload">
        <img id="plan1" src="plan1.png">
        <img id="plan2" src="plan2.png">
        <img id="plan3" src="plan3.png">
        <img id="plan4" src="plan4.png">
        <img id="cible" src="cible.png">
        <img id="fleche" src="fleche.png">
    </div>

    <canvas id="mainCanvas" height="1080" width="1920"></canvas>

    <div style="text-align: center">
        <button type="button" onmouseenter="move(-1)" onmouseleave="move(0)">&lt;</button> 
        <button type="button" onmouseenter="move(+1)" onmouseleave="move(0)">&gt;</button> 
    </div>

    <script>

        var nbPlans = 4
        var position = -50
        var scrollSpeed = 0
        var flecheP = null
        var flecheV = null
        var flecheA = {x: 0, y: 2, z: 0}

        function updateScreen() {
            updatePlansNodes(position)
            updateCibleNode(position)
        }

        function updatePlansNodes(position) {
            var mainCanvas = document.getElementById("mainCanvas")
            var ctx = mainCanvas.getContext('2d')
            var flecheDrawn = false

            // remove this when done
            ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height)

            for(var i=nbPlans; i>0; i--) {

                var planId = "plan"+i
                var planNode = document.getElementById(planId)

                var distancePlan = (6 + i)*10;
                                
                var startX = (2500 - 1920)/2 + position * 300 / distancePlan
                ctx.drawImage(planNode, startX, 0, 1920, 1080, 0, 0, 1920, 1080)

                // dessin fleche
                if ((!flecheDrawn) && ((i==1) || (flecheP.z > distancePlan)) ) {
                    var flecheId = "fleche"
                    var flecheNode = document.getElementById(flecheId)
                    var flecheWidth = flecheNode.width
                    var flecheHeight = fleche.height
                    var flecheApparentWidth = flecheNode.width * 50 / flecheP.z
                    var flecheApparentHeight = flecheNode.height * 50 / flecheP.z
                    ctx.globalAlpha = 0.9
                    ctx.drawImage(flecheNode, 0, 0, 64, 64, (1920 - flecheApparentWidth) / 2 + flecheP.x / flecheP.z, (1080 - flecheApparentHeight) / 2 + flecheP.y / flecheP.z, flecheApparentWidth, flecheApparentHeight)
                    ctx.globalAlpha = 1

                    flecheDrawn = true
                }
            }

        }

        function updateCibleNode(position) {
        }

        function move(x) {
            scrollSpeed = x
        }

        function autoScroll(timestamp) {
            position += scrollSpeed

            if ((flecheP==null) || (flecheP.z > 120)) {
                flecheP = {x: 0, y: 0, z: 50}
                flecheV = {x: 0, y: -150, z: 0.6}
            }

            flecheV.x += flecheA.x
            flecheV.y += flecheA.y
            flecheV.z += flecheA.z

            flecheP.x += flecheV.x
            flecheP.y += flecheV.y
            flecheP.z += flecheV.z

            console.log(position + " " + flecheP.z)

            updateScreen()
            requestAnimationFrame(autoScroll)
        }
        
        window.addEventListener('load', autoScroll)

    </script>


</body>
